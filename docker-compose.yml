services:

  camoufox-agent:
    build: .
    container_name: camoufox-agent
    ports:
      - "5555:5555"
      - "6080:6080"
    volumes:
      - /data/camoufox/screenshots:/workspace/screenshots
      - /data/camoufox/logs:/workspace/logs
    environment:
      OLLAMABASE: http://192.168.10.50:11434
      VLMMODEL: redule26/huihui_ai_qwen2.5-vl-7b-abliterated:latest
      CAMOUFOXVISUAL: "true"  # HEADLESS derives from this in code
      PYTHONUNBUFFERED: "1"
      NAV_TIMEOUT_MS: "60000"
      SHOT_TIMEOUT_MS: "60000"
      DEBUG_DWELL_SEC: "120"
    dns:
      - 192.168.10.50
      - 1.1.1.1
    mem_limit: 4g
    shm_size: 2gb
    restart: unless-stopped

  camoufox:
    image: caussiaus/camoufox:latest  # Your custom image
    restart: unless-stopped
    
    ports:
      - "6080:6080"  # noVNC web interface
      - "5900:5900"  # VNC server
    
    environment:
      - DISPLAY=:99
    
    volumes:
      - /data/camoufox:/root/.cache/camoufox  # Changed from named volume
      - /data/vision-agent/processed_images:/screenshots  # Share with n8n
      - /data/camoufox/scripts:/workspace  # Your scripts
    
    shm_size: '2gb'  # CRITICAL - prevents browser crashes
    
    networks:
      - coolify
    
    labels:
      - coolify.managed=true
      - caddy=camoufox.caseyjussaume.com
      - caddy.reverse_proxy={{upstreams 6080}}  # Changed from 8080
